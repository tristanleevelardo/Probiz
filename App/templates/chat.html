{% extends 'base.html' %}
{% load static %}
{% block content %}

<style>
  .container {
    margin-top: 30px;
    display: flex;
    justify-content: flex-end;
    align-items: center;
  }

  .col-md-8 {
    width: 70%; /* Adjust the width of the chat box as needed */
    margin-right: 0%; /* Adjust the negative margin to move it to the right */
  }

  .card {
    border: 1px solid #ccc;
    border-radius: 10px;
  }

  .card-body {
    height: 400px;
    overflow-y: auto;
  }

  .card-footer {
    border-top: 1px solid #ccc;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .form-control {
    border-radius: 0;
  }

  .input-group-append {
    margin-left: 10px;
  }

  .btn-primary {
    font-size: 1.5rem;
    padding: 15px 30px;
  }
</style>

<div class="container">
  <div class="row">
    <div class="col-md-8 offset-md-2">
      <div class="card">
        <div class="card-body chat-box" id="chat-box">
          <!-- Chat messages will be displayed here -->
          <div id="chat-messages"></div>
        </div>
        <div class="card-footer">
          <form id="message-form">
            {% csrf_token %}
            <div class="input-group">
              <!-- Input box for typing messages -->
              <input type="text" id="message-input" class="form-control" placeholder="Type your message...">
              <!-- Button to send the message -->
              <div class="input-group-append">
                <button class="btn btn-primary" type="button" id="send-button">Send</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Include the script after jQuery and Bootstrap -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js" integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

<!-- Your custom script for handling the send button -->
<script>
  $(document).ready(function () {
    $("#send-button").on("click", function () {
      // Get the CSRF token directly from the form
      var csrftoken = $('[name=csrfmiddlewaretoken]').val();

      // Get the message from the input box
      var message = $("#message-input").val();

      // Append the user's message to the chat box
      $("#chat-messages").append('<p class="my-message">' + message + '</p>');

      // Clear the input box
      $("#message-input").val('');

      // Scroll to the bottom of the chat box
      $("#chat-box").scrollTop($("#chat-box")[0].scrollHeight);

      // Send the message to the server with the CSRF token
      $.ajax({
        type: 'POST',
        url: '{% url "send_message" %}',  // Update with your actual URL name
        data: {'message': message, csrfmiddlewaretoken: csrftoken},  // Include the CSRF token
        dataType: 'json',
        success: function (data) {
          // Handle success if needed
          if (data.status === 'success') {
            // Access the generated content from the JSON response
            var replygpt = data.replygpt;

            // Append the generated content to the chat box
            $("#chat-messages").append('<p class="reply-message">' + replygpt + '</p>');

            // Scroll to the bottom of the chat box
            $("#chat-box").scrollTop($("#chat-box")[0].scrollHeight);

            // Trigger TTS for the replygpt
            speakText(replygpt);
          }
        },
        error: function (xhr, errmsg, err) {
          // Handle errors if needed
        }
      });
    });

    // Function to speak the provided text
    function speakText(text) {
      // Create a new SpeechSynthesisUtterance instance
      var utterance = new SpeechSynthesisUtterance(text);

      // Set the voice if needed
      // utterance.voice = speechSynthesis.getVoices()[0];

      // Speak the text
      speechSynthesis.speak(utterance);
    }
  });
</script>

{% endblock %}
